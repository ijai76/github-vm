name: Mac-ARD-Tailscale-Final
on:
  workflow_dispatch:

jobs:
  build:
    name: MacRemote
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create New Admin User
        id: user_setup
        run: |
          # Kita buat user baru bernama 'adminrdp' agar tidak bentrok dengan 'runner'
          # Menggunakan sysadminctl yang lebih modern di macOS
          sudo sysadminctl -addUser adminrdp -fullName "Admin RDP" -password "Password123" -admin
          
          echo "User 'adminrdp' berhasil dibuat dengan hak akses Admin."

      - name: Install & Connect Tailscale
        id: tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # Install via brew (menghindari error 'Support Linux Only')
          brew install tailscale
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=$TAILSCALE_AUTH_KEY --hostname="Mac-ARD-${{ github.run_id }}"
          
          TS_IP=$(tailscale ip -4)
          echo "ip=$TS_IP" >> $GITHUB_OUTPUT

      - name: Enable Apple Remote Desktop (ARD)
        run: |
          # Mengaktifkan ARD untuk semua user termasuk user baru kita
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvncpw -vncpw Password123 \
          -restart -agent -privs -all

      - name: Koneksi Info
        run: |
          echo "=========================================="
          echo "KONEKSI SIAP (VIA TAILSCALE)"
          echo "=========================================="
          echo "IP Address   : ${{ steps.tailscale.outputs.ip }}"
          echo "Username     : adminrdp"
          echo "Password     : Password123"
          echo "VNC Password : Password123"
          echo "=========================================="

      - name: Keep Alive
        run: |
          while true; do
            echo "Keep alive: Mac menyala di ${{ steps.tailscale.outputs.ip }}..."
            sleep 300
          done
          
