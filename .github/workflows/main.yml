name: Mac-ARD-Tailscale-Final
on:
  workflow_dispatch:

jobs:
  build:
    name: MacRemote
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Admin User
        run: |
          sudo sysadminctl -addUser adminrdp -fullName "Admin RDP" -password "Password123" -admin

      - name: Install & Connect Tailscale
        id: tailscale
        env:
          TS_TOKEN: ${{ secrets.TAILSCALE_AUTH_TOKEN }}
        run: |
          brew install tailscale
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${TS_TOKEN} --hostname="Mac-ARD-Github" --accept-routes --reset
          echo "ip=$(tailscale ip -4)" >> $GITHUB_OUTPUT

      - name: Fix Privacy & Enable ARD
        run: |
          # 1. Paksa izin Screen Recording untuk ARD Agent lewat database TCC
          # Ini obat buat pesan "Screen recording might be disabled" di log kamu
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.RemoteManagement.RemoteManagementAgent',0,4,4,1,NULL,NULL,0,'UNUSED',NULL,0,$(date +%s));"

          # 2. Aktifkan ARD
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvncpw -vncpw Password123 \
          -restart -agent -privs -all

          # 3. Paksa resolusi layar agar tidak hitam (Headless Fix)
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          
          # 4. Pastikan tidak tidur
          caffeinate -u -t 36000 & 

      - name: Koneksi Info
        run: |
          echo "=========================================="
          echo "IP Address   : ${{ steps.tailscale.outputs.ip }}"
          echo "Username     : adminrdp"
          echo "Password     : Password123"
          echo "=========================================="

      - name: Keep Alive
        run: |
          while true; do
            # Simulasi aktivitas keyboard agar layar bangun
            osascript -e 'tell application "System Events" to key code 123'
            sleep 300
          done
          
