name: Mac-ARD-Tailscale-Final
on:
  workflow_dispatch:

jobs:
  build:
    name: MacRemote
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Admin User
        run: |
          sudo sysadminctl -addUser adminrdp -fullName "Admin RDP" -password "Password123" -admin

      - name: Install & Connect Tailscale
        id: tailscale
        env:
          TS_TOKEN: ${{ secrets.TAILSCALE_AUTH_TOKEN }}
        run: |
          brew install tailscale
          sudo tailscaled --tun=userspace-networking &
          sleep 5
          sudo tailscale up --authkey=${TS_TOKEN} --hostname="Mac-ARD-Github" --accept-routes --reset
          echo "ip=$(tailscale ip -4)" >> $GITHUB_OUTPUT

      - name: Force Enable ARD (No-TCC Method)
        run: |
          # Aktifkan ARD dengan hak akses penuh
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvncpw -vncpw Password123 \
          -restart -agent -privs -all

          # Gunakan AppleScript untuk mencoba Bypass dialog privasi (jika muncul)
          osascript -e 'tell application "System Events" to click button "Allow" of window 1 of process "RemoteManagementAgent"' || true

          # Paksa layar virtual agar ada resolusinya
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          
          # Mencegah sistem Sleep yang bikin port tertutup
          caffeinate -u -t 36000 & 

      - name: Koneksi Info
        run: |
          echo "=========================================="
          echo "IP Address   : ${{ steps.tailscale.outputs.ip }}"
          echo "Username     : adminrdp"
          echo "Password     : Password123"
          echo "=========================================="

      - name: Keep Alive & Screen Refresh
        run: |
          while true; do
            # Paksa layar tetap "hidup" dengan simulasi tombol shift
            osascript -e 'tell application "System Events" to key code 56'
            sleep 300
          done
          
